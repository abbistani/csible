---

- name: remove savefile if present
  file:
    path: "{{ playbook_dir }}/{{ savefile | default('response.txt') }}"
    state: absent

- name: POST request
  uri:
    url: "{{ url }}"
    method: POST
    user: "{{ user }}"
    password: "{{ password }}"
    body: "{{ lookup('file', item) }}"
    force_basic_auth: yes
    return_content: yes
    HEADER_Content-Type: "application/xml"
    status_code: 201
    validate_certs: "{{ validate_certs }}"
  register: response
  with_fileglob: "{{ directory }}/*.xml"

- name: save response
  lineinfile:
    line: "{{ item.location }}"
    dest: "{{ playbook_dir }}/{{ savefile | default('response.txt') }}"
    create: yes
  with_items: response.results
